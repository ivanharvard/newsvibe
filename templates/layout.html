<!DOCTYPE html>

<html>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, width=device-width">
        <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" rel="stylesheet">
        <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"></script>

        <!-- https://favicon.io/emoji-favicons/left-speech-bubble -->
        <link href="../static/favicon.ico" rel="icon">

        <link href="../static/styles.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=DM+Sans" rel="stylesheet">

        <title>{% block title %}{% endblock %}</title>

        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    </head>

    <body>
        <div id="loadingModal">
            <div id="loadingSpinner"></div>
        </div>

        <!-- Navbar -->
        <nav class="bg-dark navbar navbar-expand-md navbar-dark">
            <div class="container-fluid">
                <button aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#navbar" data-bs-toggle="collapse" type="button">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbar">
                    <ul class="navbar-nav me-auto mt-2">
                        <!-- Tabs for different pages -->
                        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                        <li class="nav-item"><a class="nav-link" href="/breaking" onclick="showLoadingScreen()">Breaking</a></li>
                    </ul>

                    <!-- Navbar searchbar and settings -->
                    <form class="d-flex" id="searchForm" action="/search" method="POST" onsubmit="showLoadingScreen()" autocomplete="off">
                        <input class="form-control me-2 searchbar" name="q" type="search" id="navSearchbar" placeholder="Search any topic." aria-label="Search">
                        <button type="submit" class="btn-search btn">
                            <img src="../static/search.png" alt="Search">
                        </button>
                        <button type="button" class="btn-settings btn">
                            <img src="../static/settings.png" alt="Settings">
                        </button>
                    </form>
                </div>
            </nav>

        <!-- Background -->
            <div class="circle-large"></div>
            <div class="circle-medium"></div>
            <div class="circle-small"></div>

        <!-- Main -->
            <main class="container-fluid py-5 text-center background">
                {% block main %}{% endblock %}
            </main>

        <!-- Settings -->
            <div id="settingsModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h1>Settings</h1>
                    <p class="small text-muted">
                        Leave blank for default settings.
                        You can search articles up to a month old.
                    </p>

                <!-- Sources -->
                    <div class="settings-section">
                        <h2>Sources</h2>
                        <div class="searchbar-container">
                            <input class="form-control me-2 searchbar-sm" id="sourceSearch" type="search" placeholder="Search for sources." aria-label="Search" oninput="filterSources()">
                            <button type="button" id="selectAllSources" onclick="selectAllSources(this)"> Select All</button>
                        </div>
                        <hr>
                        <div class="scrollable-list">
                            <div id="sourceList" class="list-container">
                                <ul id="sourceListColumns" class="list-columns">
                                    {% for source in sources %}
                                        <li class="list-item" onclick="toggleSource('{{ source }}', this)">
                                            <div class="list-item-block">{{ source }}</div>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <form method="POST" action="/search">
                    <!-- General -->
                        <div class="settings-section">
                            <h2>General</h2>
                            <div class="date-inputs">
                                <label for="startDate">From:</label>
                                <input type="text" id="startDate" name="startDate" pattern="\d{4}-\d{2}-\d{2}" placeholder="YYYY-MM-DD">
                                <label for="endDate">To:</label>
                                <input type="text" id="endDate" name="endDate" pattern="\d{4}-\d{2}-\d{2}" placeholder="YYYY-MM-DD">
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        <!-- Invisible input that holds all of the sources so it can be pulled by Flask app -->
            <input type="hidden" id="selectedSources" name="selectedSources" value="">

        <!-- jQuery to display or hide settings menu -->
            <script>
                $(document).ready(function() {
                    $(".btn-settings").click(function() {
                        $("#settingsModal").css("display", "block");
                    });

                    $(".close").click(function() {
                        $("#settingsModal").css("display", "none");
                    });

                    $(window).click(function(event) {
                        if (event.target.id === "settingsModal") {
                            $("#settingsModal").css("display", "none");
                        }
                    });
                });
            </script>

        <!-- Javascript to control sources in settings -->
            <script>
                var source_list = [];
                var sources = [];

            // Fetch sources from the server
                fetch('/get_sources')
                    .then(response => response.json())
                    .then(data => {
                        sources = data; // Assign the fetched sources to the global variable
                    })

                function toggleSource(sourceName, buttonElement) {
                    var index = source_list.indexOf(sourceName);
                    var block = buttonElement.querySelector('.list-item-block');

                // Check if the clicked source is the "Select All" button
                    if (sourceName === 'Select All') {
                    // Toggle all sources based on the state of the "Select All" button
                        var selectAllButton = document.getElementById('selectAllSources');
                        if (selectAllButton.classList.contains('selected')) {
                        // If "Select All" is checked, select all sources
                            source_list = sources.slice();
                        // Add the 'selected' class to all source blocks
                            document.querySelectorAll('.list-item-block').forEach(function(block) {
                                block.classList.remove('unselected');
                                block.classList.add('selected');
                            });
                        } else {
                        // If "Select All" is unchecked, deselect all sources
                            source_list = [];
                        // Add the 'unselected' class to all source blocks
                            document.querySelectorAll('.list-item-block').forEach(function(block) {
                                block.classList.remove('selected');
                                block.classList.add('unselected');
                            });
                        }
                    } else {
                    // If the clicked source is not the "Select All" button
                        if (index === -1) {
                        // If the source is not in the list, add it
                            source_list.push(sourceName);
                            block.classList.remove('unselected');
                            block.classList.add('selected');
                        } else {
                        // If the source is in the list, remove it
                            source_list.splice(index, 1);
                            block.classList.remove('selected');
                            block.classList.add('unselected');
                        }
                    }

                // Updates sources
                    fetch('/update_sources', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sources: source_list
                        }),
                    });

                    updateSelectedSourcesInput();
                }

            // Updates CSS and then updates source selection
                var i = 0;

                function selectAllSources(element) {
                    i++;

                    if (i === 1) {
                        element.classList.add('selected');
                        element.classList.remove('unselected');
                    } else {
                        element.classList.remove('selected');
                        element.classList.add('unselected');
                        i = 0;
                    }

                    toggleSource('Select All', document.getElementById('selectAllSources'));
                }

            // Updates hidden input to transfer over to Flask
                function updateSelectedSourcesInput() {
                    document.getElementById('selectedSources').value = JSON.stringify(source_list);
                }

            // Controls searchbar to filter source results
                function filterSources() {
                    var input, filter, ul, li, a, i, txtValue;
                    input = document.getElementById('sourceSearch');
                    filter = input.value.toUpperCase();
                    ul = document.getElementById('sourceListColumns');
                    li = ul.getElementsByTagName('li');

                    for (i = 0; i < li.length; i++) {
                        a = li[i].querySelector('.list-item-block');
                        txtValue = a.textContent || a.innerText;

                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            li[i].style.display = '';
                        } else {
                            li[i].style.display = 'none';
                        }
                    }
                }
            </script>

        <!-- JavaScript for loading screen  -->
            <script>
            // Shows loading screen when page is submitted
                function showLoadingScreen() {
                    document.getElementById('loadingModal').style.display = 'flex';
                }
            </script>
        </body>

    </html>